<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Chauffeur - EcoRide</title>
    <link rel="stylesheet" href="public/css/style.css">
    <script src="public/js/config.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #27ae60;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        .dashboard-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .section-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            background: #34495e;
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .vehicle-list, .ride-list {
            margin-bottom: 20px;
        }
        
        .vehicle-item, .ride-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .vehicle-header, .ride-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .eco-badge {
            background: #27ae60;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            color: white;
        }
        
        .status-active { background: #27ae60; }
        .status-cancelled { background: #e74c3c; }
        .status-pending { background: #f39c12; }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        
        .driver-profile {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .preference-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        @media (max-width: 768px) {
            .dashboard-sections {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="public/images/logo.png" alt="EcoRide" class="logo">
                <span>EcoRide</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="covoiturages.html">Rechercher</a></li>
                <li><a href="espace-chauffeur.html" class="active">Espace Chauffeur</a></li>
                <li><a href="espace-utilisateur.html">Mon Compte</a></li>
                <li><a href="#" onclick="logout()">D√©connexion</a></li>
            </ul>
        </div>
    </nav>

    <main class="dashboard-container">
        <!-- En-t√™te du tableau de bord -->
        <div class="dashboard-header">
            <h1>üöó Espace Chauffeur EcoRide</h1>
            <p>G√©rez vos v√©hicules et cr√©ez vos covoiturages</p>
            <div id="user-info" class="user-info">
                <span id="driver-name">Chargement...</span> | 
                <span id="credit-balance">üí∞ -- cr√©dits</span>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="quick-actions">
            <button class="btn btn-success" onclick="showAddVehicleModal()">
                üöô Ajouter un v√©hicule
            </button>
            <button class="btn btn-primary" onclick="showCreateRideModal()">
                ‚ûï Cr√©er un covoiturage
            </button>
            <button class="btn btn-warning" onclick="showPreferencesModal()">
                ‚öôÔ∏è Mes pr√©f√©rences
            </button>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-vehicles">0</div>
                <div>V√©hicules enregistr√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-rides">0</div>
                <div>Trajets actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-passengers">0</div>
                <div>Passagers transport√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="eco-score">0</div>
                <div>Score √©cologique</div>
            </div>
        </div>

        <!-- Sections principales -->
        <div class="dashboard-sections">
            <!-- Gestion des v√©hicules (US8) -->
            <div class="section-card">
                <div class="section-header">
                    üöó Mes V√©hicules (US8)
                </div>
                <div class="section-content">
                    <div id="vehicles-container">
                        <div class="empty-state">
                            <i>üöó</i>
                            <p>Aucun v√©hicule enregistr√©</p>
                            <button class="btn btn-primary" onclick="showAddVehicleModal()">
                                Ajouter votre premier v√©hicule
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestion des trajets (US9) -->
            <div class="section-card">
                <div class="section-header">
                    üõ£Ô∏è Mes Covoiturages (US9)
                </div>
                <div class="section-content">
                    <div id="rides-container">
                        <div class="empty-state">
                            <i>üõ£Ô∏è</i>
                            <p>Aucun covoiturage cr√©√©</p>
                            <button class="btn btn-primary" onclick="showCreateRideModal()">
                                Cr√©er votre premier trajet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profil chauffeur -->
        <div class="section-card" style="margin-top: 30px;">
            <div class="section-header">
                üë§ Mon Profil Chauffeur
            </div>
            <div class="section-content">
                <div class="driver-profile" id="driver-profile">
                    <h4>Pr√©f√©rences de conduite</h4>
                    <div class="preferences-grid" id="preferences-grid">
                        <!-- Pr√©f√©rences charg√©es dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Ajouter V√©hicule -->
    <div id="add-vehicle-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöó Ajouter un v√©hicule</h3>
                <span class="close" onclick="closeModal('add-vehicle-modal')">&times;</span>
            </div>
            <form id="add-vehicle-form">
                <div class="form-group">
                    <label for="vehicle-brand">Marque *</label>
                    <input type="text" id="vehicle-brand" required placeholder="Ex: Renault">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-model">Mod√®le *</label>
                    <input type="text" id="vehicle-model" required placeholder="Ex: Clio">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-year">Ann√©e</label>
                    <input type="number" id="vehicle-year" min="1990" max="2024" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-energy">Type d'√©nergie *</label>
                    <select id="vehicle-energy" required>
                        <option value="">S√©lectionnez...</option>
                        <option value="electric">üîã √âlectrique</option>
                        <option value="hybrid">‚ö° Hybride</option>
                        <option value="gasoline">‚õΩ Essence</option>
                        <option value="diesel">üõ¢Ô∏è Diesel</option>
                        <option value="gpl">üî• GPL</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vehicle-seats">Nombre de places *</label>
                    <select id="vehicle-seats" required>
                        <option value="">S√©lectionnez...</option>
                        <option value="2">2 places</option>
                        <option value="4">4 places</option>
                        <option value="5">5 places</option>
                        <option value="7">7 places</option>
                        <option value="9">9 places</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vehicle-color">Couleur</label>
                    <input type="text" id="vehicle-color" placeholder="Ex: Bleu">
                </div>
                
                <div class="form-group">
                    <label for="vehicle-plate">Plaque d'immatriculation</label>
                    <input type="text" id="vehicle-plate" placeholder="Ex: AB-123-CD">
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Ajouter le v√©hicule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-vehicle-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cr√©er Covoiturage -->
    <div id="create-ride-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Cr√©er un covoiturage</h3>
                <span class="close" onclick="closeModal('create-ride-modal')">&times;</span>
            </div>
            <form id="create-ride-form">
                <div class="form-group">
                    <label for="ride-vehicle">V√©hicule *</label>
                    <select id="ride-vehicle" required>
                        <option value="">S√©lectionnez un v√©hicule...</option>
                        <!-- Options charg√©es dynamiquement -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ride-departure">Ville de d√©part *</label>
                    <input type="text" id="ride-departure" required placeholder="Ex: Paris">
                </div>
                
                <div class="form-group">
                    <label for="ride-arrival">Ville d'arriv√©e *</label>
                    <input type="text" id="ride-arrival" required placeholder="Ex: Lyon">
                </div>
                
                <div class="form-group">
                    <label for="ride-date">Date du trajet *</label>
                    <input type="date" id="ride-date" required>
                </div>
                
                <div class="form-group">
                    <label for="ride-time">Heure de d√©part *</label>
                    <input type="time" id="ride-time" required>
                </div>
                
                <div class="form-group">
                    <label for="ride-seats">Places disponibles *</label>
                    <select id="ride-seats" required>
                        <option value="">S√©lectionnez...</option>
                        <option value="1">1 place</option>
                        <option value="2">2 places</option>
                        <option value="3">3 places</option>
                        <option value="4">4 places</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="ride-price">Prix par passager (‚Ç¨) *</label>
                    <input type="number" id="ride-price" min="1" step="0.5" required placeholder="15.00">
                    <small>üí° Commission EcoRide : 2 cr√©dits par trajet</small>
                </div>
                
                <div class="form-group">
                    <label for="ride-description">Description (optionnel)</label>
                    <textarea id="ride-description" rows="3" placeholder="Informations suppl√©mentaires..."></textarea>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Cr√©er le covoiturage</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('create-ride-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pr√©f√©rences -->
    <div id="preferences-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Mes pr√©f√©rences de conduite</h3>
                <span class="close" onclick="closeModal('preferences-modal')">&times;</span>
            </div>
            <form id="preferences-form">
                <div class="form-group">
                    <label for="pref-smoking">Autoriser les fumeurs ?</label>
                    <select id="pref-smoking">
                        <option value="no">üö≠ Non-fumeur uniquement</option>
                        <option value="yes">üö¨ Fumeurs accept√©s</option>
                        <option value="outside">üå¨Ô∏è Pause fumeur possible</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-pets">Autoriser les animaux ?</label>
                    <select id="pref-pets">
                        <option value="no">üö´ Pas d'animaux</option>
                        <option value="small">üêï Petits animaux seulement</option>
                        <option value="yes">üêæ Tous animaux accept√©s</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-conversation">Niveau de conversation</label>
                    <select id="pref-conversation">
                        <option value="quiet">ü§´ Trajet silencieux</option>
                        <option value="moderate">üí¨ Conversation mod√©r√©e</option>
                        <option value="talkative">üó£Ô∏è J'aime discuter</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pref-music">Musique pendant le trajet</label>
                    <select id="pref-music">
                        <option value="no">üîá Pas de musique</option>
                        <option value="soft">üéµ Musique douce</option>
                        <option value="choice">üé∂ Au choix des passagers</option>
                        <option value="driver">üé∏ Ma playlist</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('preferences-modal')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script src="public/js/script.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let vehicles = [];
        let rides = [];

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadDriverData();
            
            // Configuration de la date minimum pour les trajets
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ride-date').min = today;
        });

        // V√©rification de l'authentification
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token || !user.id) {
                alert('Vous devez √™tre connect√© pour acc√©der √† cette page.');
                window.location.href = 'connexion.html';
                return;
            }
            
            // V√©rifier si l'utilisateur est un chauffeur
            if (user.role !== 'driver' && user.role !== 'admin') {
                alert('Acc√®s r√©serv√© aux chauffeurs. Veuillez vous inscrire comme chauffeur.');
                window.location.href = 'espace-utilisateur.html';
                return;
            }
            
            currentUser = user;
            updateUserInfo();
        }

        // Mise √† jour des informations utilisateur
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('driver-name').textContent = currentUser.name || 'Chauffeur';
                loadCreditBalance();
            }
        }

        // Chargement du solde de cr√©dits
        async function loadCreditBalance() {
            try {
                const response = await window.fetchWithAuth(window.getApiUrl('/credits/balance'));
                
                if (response.ok) {
                    const data = await response.json();
                    const credits = data.data ? data.data.current_credits : data.current_credits;
                    document.getElementById('credit-balance').textContent = `üí∞ ${credits} cr√©dits`;
                } else {
                    console.error('Erreur chargement cr√©dits:', response.status);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des cr√©dits:', error);
            }
        }

        // Chargement des donn√©es du chauffeur
        async function loadDriverData() {
            await Promise.all([
                loadVehicles(),
                loadRides(),
                loadDriverPreferences(),
                loadStatistics()
            ]);
        }

        // Chargement des v√©hicules
        async function loadVehicles() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    vehicles = await response.json();
                    displayVehicles();
                    updateVehicleOptions();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des v√©hicules:', error);
            }
        }

        // Affichage des v√©hicules
        function displayVehicles() {
            const container = document.getElementById('vehicles-container');
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>üöó</i>
                        <p>Aucun v√©hicule enregistr√©</p>
                        <button class="btn btn-primary" onclick="showAddVehicleModal()">
                            Ajouter votre premier v√©hicule
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = vehicles.map(vehicle => `
                <div class="vehicle-item">
                    <div class="vehicle-header">
                        <h4>${vehicle.brand} ${vehicle.model} ${vehicle.year || ''}</h4>
                        <span class="eco-badge">${getEnergyEmoji(vehicle.energy_type)} ${getEnergyLabel(vehicle.energy_type)}</span>
                    </div>
                    <p>
                        ü™ë ${vehicle.seats} places | 
                        üé® ${vehicle.color || 'N/A'} | 
                        üî¢ ${vehicle.license_plate || 'N/A'}
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="editVehicle(${vehicle.id})">Modifier</button>
                        <button class="btn btn-danger" onclick="deleteVehicle(${vehicle.id})">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        // Chargement des trajets
        async function loadRides() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides/my-rides', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    rides = await response.json();
                    displayRides();
                }
            } catch (error) {
                console.error('Erreur lors du chargement des trajets:', error);
            }
        }

        // Affichage des trajets
        function displayRides() {
            const container = document.getElementById('rides-container');
            
            if (rides.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i>üõ£Ô∏è</i>
                        <p>Aucun covoiturage cr√©√©</p>
                        <button class="btn btn-primary" onclick="showCreateRideModal()">
                            Cr√©er votre premier trajet
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = rides.map(ride => `
                <div class="ride-item">
                    <div class="ride-header">
                        <h4>${ride.departure_city} ‚Üí ${ride.arrival_city}</h4>
                        <span class="status-badge status-${ride.status}">${getStatusLabel(ride.status)}</span>
                    </div>
                    <p>
                        üìÖ ${formatDate(ride.departure_date)} √† ${ride.departure_time} | 
                        üí∞ ${ride.price_per_passenger}‚Ç¨ | 
                        ü™ë ${ride.available_seats}/${ride.total_seats} places
                    </p>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="viewRideDetails(${ride.id})">D√©tails</button>
                        ${ride.status === 'active' ? `
                            <button class="btn btn-warning" onclick="updateRideStatus(${ride.id}, 'started')">D√©marrer</button>
                            <button class="btn btn-danger" onclick="cancelRide(${ride.id})">Annuler</button>
                        ` : ''}
                        ${ride.status === 'started' ? `
                            <button class="btn btn-success" onclick="updateRideStatus(${ride.id}, 'completed')">Terminer</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Chargement des pr√©f√©rences chauffeur
        async function loadDriverPreferences() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/driver-preferences', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const preferences = await response.json();
                    displayDriverPreferences(preferences);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des pr√©f√©rences:', error);
            }
        }

        // Affichage des pr√©f√©rences
        function displayDriverPreferences(preferences) {
            const container = document.getElementById('preferences-grid');
            
            if (!preferences || Object.keys(preferences).length === 0) {
                container.innerHTML = `
                    <div class="preference-item">
                        <p>Aucune pr√©f√©rence d√©finie</p>
                        <button class="btn btn-primary" onclick="showPreferencesModal()">D√©finir mes pr√©f√©rences</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="preference-item">
                    <strong>üö≠ Fumeurs</strong>
                    <p>${getPreferenceLabel('smoking', preferences.smoking_allowed)}</p>
                </div>
                <div class="preference-item">
                    <strong>üêæ Animaux</strong>
                    <p>${getPreferenceLabel('pets', preferences.pets_allowed)}</p>
                </div>
                <div class="preference-item">
                    <strong>üí¨ Conversation</strong>
                    <p>${getPreferenceLabel('conversation', preferences.conversation_level)}</p>
                </div>
                <div class="preference-item">
                    <strong>üéµ Musique</strong>
                    <p>${getPreferenceLabel('music', preferences.music_preference)}</p>
                </div>
            `;
        }

        // Chargement des statistiques
        async function loadStatistics() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides/statistics', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    updateStatistics(stats);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
                // Affichage des statistiques locales
                updateStatistics({
                    totalVehicles: vehicles.length,
                    activeRides: rides.filter(r => r.status === 'active').length,
                    totalPassengers: 0,
                    ecoScore: calculateEcoScore()
                });
            }
        }

        // Mise √† jour des statistiques
        function updateStatistics(stats) {
            document.getElementById('total-vehicles').textContent = stats.totalVehicles || vehicles.length;
            document.getElementById('active-rides').textContent = stats.activeRides || rides.filter(r => r.status === 'active').length;
            document.getElementById('total-passengers').textContent = stats.totalPassengers || 0;
            document.getElementById('eco-score').textContent = stats.ecoScore || calculateEcoScore();
        }

        // Calcul du score √©cologique
        function calculateEcoScore() {
            const ecoPoints = vehicles.reduce((total, vehicle) => {
                const points = {
                    'electric': 100,
                    'hybrid': 80,
                    'gpl': 60,
                    'gasoline': 40,
                    'diesel': 30
                };
                return total + (points[vehicle.energy_type] || 0);
            }, 0);
            
            return Math.round(ecoPoints / Math.max(vehicles.length, 1));
        }

        // Gestion des modaux
        function showAddVehicleModal() {
            document.getElementById('add-vehicle-modal').style.display = 'block';
        }

        function showCreateRideModal() {
            document.getElementById('create-ride-modal').style.display = 'block';
        }

        function showPreferencesModal() {
            document.getElementById('preferences-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Gestion des formulaires
        document.getElementById('add-vehicle-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const vehicleData = {
                brand: document.getElementById('vehicle-brand').value,
                model: document.getElementById('vehicle-model').value,
                year: document.getElementById('vehicle-year').value || null,
                energy_type: document.getElementById('vehicle-energy').value,
                seats: parseInt(document.getElementById('vehicle-seats').value),
                color: document.getElementById('vehicle-color').value || null,
                license_plate: document.getElementById('vehicle-plate').value || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(vehicleData)
                });
                
                if (response.ok) {
                    alert('V√©hicule ajout√© avec succ√®s !');
                    closeModal('add-vehicle-modal');
                    document.getElementById('add-vehicle-form').reset();
                    loadVehicles();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'ajout du v√©hicule');
            }
        });

        document.getElementById('create-ride-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rideData = {
                vehicle_id: parseInt(document.getElementById('ride-vehicle').value),
                departure_city: document.getElementById('ride-departure').value,
                arrival_city: document.getElementById('ride-arrival').value,
                departure_date: document.getElementById('ride-date').value,
                departure_time: document.getElementById('ride-time').value,
                available_seats: parseInt(document.getElementById('ride-seats').value),
                price_per_passenger: parseFloat(document.getElementById('ride-price').value),
                description: document.getElementById('ride-description').value || null
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/rides', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(rideData)
                });
                
                if (response.ok) {
                    alert('Covoiturage cr√©√© avec succ√®s !');
                    closeModal('create-ride-modal');
                    document.getElementById('create-ride-form').reset();
                    loadRides();
                    loadCreditBalance(); // Recharger le solde de cr√©dits
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la cr√©ation du covoiturage');
            }
        });

        document.getElementById('preferences-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const preferencesData = {
                smoking_allowed: document.getElementById('pref-smoking').value,
                pets_allowed: document.getElementById('pref-pets').value,
                conversation_level: document.getElementById('pref-conversation').value,
                music_preference: document.getElementById('pref-music').value
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/vehicles/driver-preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(preferencesData)
                });
                
                if (response.ok) {
                    alert('Pr√©f√©rences sauvegard√©es avec succ√®s !');
                    closeModal('preferences-modal');
                    loadDriverPreferences();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la sauvegarde des pr√©f√©rences');
            }
        });

        // Fonctions utilitaires
        function updateVehicleOptions() {
            const select = document.getElementById('ride-vehicle');
            select.innerHTML = '<option value="">S√©lectionnez un v√©hicule...</option>';
            
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.brand} ${vehicle.model} (${vehicle.seats} places)`;
                select.appendChild(option);
            });
        }

        function getEnergyEmoji(energyType) {
            const emojis = {
                'electric': 'üîã',
                'hybrid': '‚ö°',
                'gasoline': '‚õΩ',
                'diesel': 'üõ¢Ô∏è',
                'gpl': 'üî•'
            };
            return emojis[energyType] || 'üöó';
        }

        function getEnergyLabel(energyType) {
            const labels = {
                'electric': '√âlectrique',
                'hybrid': 'Hybride',
                'gasoline': 'Essence',
                'diesel': 'Diesel',
                'gpl': 'GPL'
            };
            return labels[energyType] || energyType;
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Actif',
                'started': 'En cours',
                'completed': 'Termin√©',
                'cancelled': 'Annul√©'
            };
            return labels[status] || status;
        }

        function getPreferenceLabel(type, value) {
            const labels = {
                smoking: {
                    'no': 'üö≠ Non-fumeur',
                    'yes': 'üö¨ Accept√©',
                    'outside': 'üå¨Ô∏è Pause possible'
                },
                pets: {
                    'no': 'üö´ Interdits',
                    'small': 'üêï Petits seulement',
                    'yes': 'üêæ Accept√©s'
                },
                conversation: {
                    'quiet': 'ü§´ Silencieux',
                    'moderate': 'üí¨ Mod√©r√©',
                    'talkative': 'üó£Ô∏è Bavard'
                },
                music: {
                    'no': 'üîá Pas de musique',
                    'soft': 'üéµ Douce',
                    'choice': 'üé∂ Au choix',
                    'driver': 'üé∏ Ma playlist'
                }
            };
            return labels[type]?.[value] || value;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Actions sur les v√©hicules et trajets
        async function deleteVehicle(vehicleId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce v√©hicule ?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/vehicles/${vehicleId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('V√©hicule supprim√© avec succ√®s !');
                    loadVehicles();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la suppression du v√©hicule');
            }
        }

        async function cancelRide(rideId) {
            if (!confirm('√ätes-vous s√ªr de vouloir annuler ce trajet ?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/rides/${rideId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Trajet annul√© avec succ√®s !');
                    loadRides();
                    loadCreditBalance(); // Recharger le solde
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'annulation du trajet');
            }
        }

        async function updateRideStatus(rideId, newStatus) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/rides/${rideId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert('Statut mis √† jour avec succ√®s !');
                    loadRides();
                } else {
                    const error = await response.json();
                    alert('Erreur : ' + error.message);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la mise √† jour du statut');
            }
        }

        function viewRideDetails(rideId) {
            window.location.href = `details-covoiturage.html?id=${rideId}`;
        }

        function editVehicle(vehicleId) {
            // TODO: Impl√©menter la modification de v√©hicule
            alert('Fonctionnalit√© de modification en cours de d√©veloppement');
        }

        // Fermer les modaux en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // D√©connexion
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>