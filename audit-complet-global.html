<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Audit Complet EcoRide - Test Global</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .test-section { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .loading { background: #e2e3e5; border-color: #d6d8db; color: #6c757d; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 11px; max-height: 200px; overflow-y: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        h1 { text-align: center; color: #2c5aa0; }
        h2 { margin-top: 0; font-size: 16px; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; margin: 20px 0; }
        .progress-bar { height: 100%; background: #28a745; border-radius: 10px; transition: width 0.3s; }
        .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç AUDIT COMPLET ECORIDE - Test Global</h1>
        
        <div class="summary">
            <h2>üìä R√©sum√© de l'Audit</h2>
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            <p><strong>Progression:</strong> <span id="progress-text">0/10 tests</span></p>
            <p><strong>Score Global:</strong> <span id="global-score">En cours...</span></p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn-primary" onclick="runAllTests()">üöÄ Lancer Audit Complet</button>
            <button class="btn-success" onclick="runCriticalTests()">‚ö° Tests Critiques</button>
            <button class="btn-warning" onclick="resetTests()">üîÑ Reset</button>
        </div>

        <div class="test-grid">
            <div id="test-server" class="test-section loading">
                <h2>üñ•Ô∏è Serveur</h2>
                <p id="server-status">En attente...</p>
                <button class="btn-primary" onclick="testServer()">Test</button>
            </div>

            <div id="test-database" class="test-section loading">
                <h2>üóÑÔ∏è Base de Donn√©es</h2>
                <p id="database-status">En attente...</p>
                <button class="btn-primary" onclick="testDatabase()">Test</button>
            </div>

            <div id="test-auth" class="test-section loading">
                <h2>üîê Authentification</h2>
                <p id="auth-status">En attente...</p>
                <button class="btn-primary" onclick="testAuth()">Test</button>
            </div>

            <div id="test-registration" class="test-section loading">
                <h2>üë§ Inscription</h2>
                <p id="registration-status">En attente...</p>
                <button class="btn-primary" onclick="testRegistration()">Test</button>
            </div>

            <div id="test-profile" class="test-section loading">
                <h2>üë®‚Äçüíº Profil Utilisateur</h2>
                <p id="profile-status">En attente...</p>
                <button class="btn-primary" onclick="testProfile()">Test</button>
            </div>

            <div id="test-vehicles" class="test-section loading">
                <h2>üöó V√©hicules</h2>
                <p id="vehicles-status">En attente...</p>
                <button class="btn-primary" onclick="testVehicles()">Test</button>
            </div>

            <div id="test-rides" class="test-section loading">
                <h2>üõ£Ô∏è Trajets</h2>
                <p id="rides-status">En attente...</p>
                <button class="btn-primary" onclick="testRides()">Test</button>
            </div>

            <div id="test-security" class="test-section loading">
                <h2>üîí S√©curit√©</h2>
                <p id="security-status">En attente...</p>
                <button class="btn-primary" onclick="testSecurity()">Test</button>
            </div>

            <div id="test-frontend" class="test-section loading">
                <h2>üé® Frontend</h2>
                <p id="frontend-status">En attente...</p>
                <button class="btn-primary" onclick="testFrontend()">Test</button>
            </div>

            <div id="test-performance" class="test-section loading">
                <h2>‚ö° Performance</h2>
                <p id="performance-status">En attente...</p>
                <button class="btn-primary" onclick="testPerformance()">Test</button>
            </div>
        </div>

        <div id="detailed-logs" class="test-section" style="margin-top: 20px;">
            <h2>üìù Logs D√©taill√©s</h2>
            <pre id="logs">Logs en attente...</pre>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:3002/api';
        const logs = [];
        let completedTests = 0;
        const totalTests = 10;
        let globalScore = 0;
        let authToken = null;

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            document.getElementById('logs').textContent = logs.join('\\n');
        }

        function updateProgress() {
            const percentage = (completedTests / totalTests) * 100;
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completedTests}/${totalTests} tests`;
            document.getElementById('global-score').textContent = `${Math.round(globalScore/completedTests)} / 100`;
        }

        function setTestResult(testId, status, message, score) {
            const element = document.getElementById(testId);
            const statusElement = document.getElementById(testId.replace('test-', '') + '-status');
            
            element.className = `test-section ${status}`;
            statusElement.innerHTML = message;
            
            completedTests++;
            globalScore += score;
            updateProgress();
            
            addLog(`Test ${testId}: ${message} (Score: ${score}/100)`);
        }

        async function testServer() {
            addLog('üñ•Ô∏è Test du serveur...');
            try {
                const response = await fetch(`${API_BASE_URL.replace('/api', '')}/health`);
                if (response.status === 404) {
                    // Le serveur r√©pond mais pas de route /health
                    setTestResult('test-server', 'success', '‚úÖ Serveur actif (port 3002)', 95);
                } else if (response.ok) {
                    setTestResult('test-server', 'success', '‚úÖ Serveur parfaitement fonctionnel', 100);
                } else {
                    setTestResult('test-server', 'warning', `‚ö†Ô∏è Serveur r√©pond (${response.status})`, 70);
                }
            } catch (error) {
                setTestResult('test-server', 'error', '‚ùå Serveur inaccessible', 0);
            }
        }

        async function testDatabase() {
            addLog('üóÑÔ∏è Test de la base de donn√©es...');
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@invalid.com', password: 'test' })
                });
                
                if (response.status === 400) {
                    setTestResult('test-database', 'success', '‚úÖ Base de donn√©es accessible', 100);
                } else {
                    setTestResult('test-database', 'warning', '‚ö†Ô∏è R√©ponse inattendue', 70);
                }
            } catch (error) {
                setTestResult('test-database', 'error', '‚ùå Erreur base de donn√©es', 0);
            }
        }

        async function testAuth() {
            addLog('üîê Test d\\'authentification...');
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@ecoride.fr', password: 'password' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success && data.data.token) {
                    authToken = data.data.token;
                    setTestResult('test-auth', 'success', '‚úÖ Connexion admin r√©ussie', 100);
                } else {
                    setTestResult('test-auth', 'error', '‚ùå √âchec connexion admin', 0);
                }
            } catch (error) {
                setTestResult('test-auth', 'error', '‚ùå Erreur authentification', 0);
            }
        }

        async function testRegistration() {
            addLog('üë§ Test d\\'inscription...');
            const randomEmail = `test${Date.now()}@ecoride.test`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pseudo: 'TestUser',
                        email: randomEmail,
                        password: 'testpassword123'
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 201 && data.success) {
                    setTestResult('test-registration', 'success', '‚úÖ Inscription fonctionnelle', 100);
                } else {
                    setTestResult('test-registration', 'warning', `‚ö†Ô∏è Probl√®me inscription: ${data.message}`, 50);
                }
            } catch (error) {
                setTestResult('test-registration', 'error', '‚ùå Erreur inscription', 0);
            }
        }

        async function testProfile() {
            addLog('üë®‚Äçüíº Test du profil utilisateur...');
            if (!authToken) {
                setTestResult('test-profile', 'warning', '‚ö†Ô∏è Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    setTestResult('test-profile', 'success', '‚úÖ Profil charg√© correctement', 100);
                } else {
                    setTestResult('test-profile', 'error', '‚ùå Erreur chargement profil', 0);
                }
            } catch (error) {
                setTestResult('test-profile', 'error', '‚ùå Erreur profil', 0);
            }
        }

        async function testVehicles() {
            addLog('üöó Test des v√©hicules...');
            if (!authToken) {
                setTestResult('test-vehicles', 'warning', '‚ö†Ô∏è Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/vehicles/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    setTestResult('test-vehicles', 'success', '‚úÖ API v√©hicules op√©rationnelle', 100);
                } else {
                    setTestResult('test-vehicles', 'warning', `‚ö†Ô∏è Statut: ${response.status}`, 70);
                }
            } catch (error) {
                setTestResult('test-vehicles', 'error', '‚ùå Erreur v√©hicules', 0);
            }
        }

        async function testRides() {
            addLog('üõ£Ô∏è Test des trajets...');
            if (!authToken) {
                setTestResult('test-rides', 'warning', '‚ö†Ô∏è Token manquant', 0);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/rides/offered`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    setTestResult('test-rides', 'success', '‚úÖ API trajets op√©rationnelle', 100);
                } else {
                    setTestResult('test-rides', 'warning', `‚ö†Ô∏è Statut: ${response.status}`, 70);
                }
            } catch (error) {
                setTestResult('test-rides', 'error', '‚ùå Erreur trajets', 0);
            }
        }

        async function testSecurity() {
            addLog('üîí Test de s√©curit√©...');
            
            // Test CORS
            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = response.headers.get('Access-Control-Allow-Origin');
                
                if (corsHeaders) {
                    setTestResult('test-security', 'success', '‚úÖ CORS configur√©', 90);
                } else {
                    setTestResult('test-security', 'warning', '‚ö†Ô∏è CORS non d√©tect√©', 60);
                }
            } catch (error) {
                setTestResult('test-security', 'error', '‚ùå Erreur s√©curit√©', 0);
            }
        }

        async function testFrontend() {
            addLog('üé® Test du frontend...');
            
            // Test des ressources CSS/JS
            const cssTest = document.querySelector('link[href*="style.css"]');
            const jsErrors = window.jsErrors || 0;
            
            if (jsErrors === 0) {
                setTestResult('test-frontend', 'success', '‚úÖ Frontend op√©rationnel', 95);
            } else {
                setTestResult('test-frontend', 'warning', `‚ö†Ô∏è ${jsErrors} erreurs JS`, 70);
            }
        }

        async function testPerformance() {
            addLog('‚ö° Test de performance...');
            
            const startTime = performance.now();
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@ecoride.fr', password: 'password' })
                });
                
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                if (responseTime < 500) {
                    setTestResult('test-performance', 'success', `‚úÖ Excellent (${Math.round(responseTime)}ms)`, 100);
                } else if (responseTime < 1000) {
                    setTestResult('test-performance', 'warning', `‚ö†Ô∏è Acceptable (${Math.round(responseTime)}ms)`, 75);
                } else {
                    setTestResult('test-performance', 'error', `‚ùå Lent (${Math.round(responseTime)}ms)`, 40);
                }
            } catch (error) {
                setTestResult('test-performance', 'error', '‚ùå Erreur performance', 0);
            }
        }

        async function runCriticalTests() {
            addLog('‚ö° D√©marrage des tests critiques...');
            resetTests();
            
            await testServer();
            await new Promise(r => setTimeout(r, 500));
            await testDatabase();
            await new Promise(r => setTimeout(r, 500));
            await testAuth();
        }

        async function runAllTests() {
            addLog('üöÄ D√©marrage de l\\'audit complet...');
            resetTests();
            
            const tests = [
                testServer,
                testDatabase,
                testAuth,
                testRegistration,
                testProfile,
                testVehicles,
                testRides,
                testSecurity,
                testFrontend,
                testPerformance
            ];
            
            for (const test of tests) {
                await test();
                await new Promise(r => setTimeout(r, 800));
            }
            
            addLog('üéâ Audit complet termin√© !');
        }

        function resetTests() {
            completedTests = 0;
            globalScore = 0;
            logs.length = 0;
            authToken = null;
            
            const testElements = document.querySelectorAll('.test-section');
            testElements.forEach(el => {
                if (el.id && el.id.startsWith('test-')) {
                    el.className = 'test-section loading';
                    const statusId = el.id.replace('test-', '') + '-status';
                    const statusEl = document.getElementById(statusId);
                    if (statusEl) statusEl.textContent = 'En attente...';
                }
            });
            
            updateProgress();
            document.getElementById('logs').textContent = 'Logs en attente...';
        }

        // Lancement automatique des tests critiques
        window.onload = () => {
            addLog('üéØ Audit EcoRide initialis√©');
            setTimeout(runCriticalTests, 1000);
        };
    </script>
</body>
</html>